name: CI

on:
  push:
    branches: ["master", "developer"]
  pull_request:
    branches: ["master"]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: my-super-library
  REGISTRY: ghcr.io

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      MONGO_URI_TEST: mongodb://localhost:27017
      DB_NAME_TEST: my_super_library_test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest -q

  docker_build_and_deploy:
    needs: test
    runs-on: ubuntu-latest

    # solo en pushes (no PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/developer')

    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (SHA + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest

      # ✅ DEPLOY a Render apuntando al TAG SHA
      # Esto fuerza un deploy “nuevo” con ese tag.
      - name: Deploy on Render using SHA tag
        run: |
          set -euo pipefail

          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "Missing RENDER_API_KEY or RENDER_SERVICE_ID. Skipping deploy."
            exit 0
          fi

          OWNER="${{ github.repository_owner }}"
          IMAGE="${REGISTRY}/${OWNER}/${IMAGE_NAME}:${{ github.sha }}"

          echo "Deploying Render service ${RENDER_SERVICE_ID} with image: ${IMAGE}"

          # 1) Update service image (PATCH)
          curl -fsS -X PATCH "https://api.render.com/v1/services/${RENDER_SERVICE_ID}" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-raw "{\"image\":{\"imagePath\":\"${IMAGE}\"}}"

          # 2) Trigger a deploy (POST)
          curl -fsS -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-raw "{}"

          echo "Render deploy triggered."
